# ============================================================
# SecurOps GitHub Actions Security Pipeline
# File: .github/workflows/security-scan.yml
#
# âœ… Optimized for PUBLIC repository (GitHub Advanced Security free)
# âœ… SARIF results show in GitHub Security tab â†’ Code scanning alerts
# âœ… CodeQL action v4 (v3 deprecated Dec 2026)
# âœ… Semgrep SARIF + JSON split into separate steps
# âœ… Trivy pinned to stable version
# ============================================================

name: "ğŸ›¡ï¸ SecurOps Security Pipeline"

on:
  pull_request:
    branches: [main, master, develop, "release/**"]
  push:
    branches: [main, master]
  schedule:
    - cron: "0 2 * * MON"  # Weekly scan Monday 2AM

permissions:
  contents: read
  security-events: write   # âœ… Enables SARIF upload to GitHub Security tab
  pull-requests: write     # âœ… Enables PR comments

jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: SECRET SCANNING (Gitleaks)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secret-scan:
    name: "ğŸ” Secret Scanning"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Gitleaks report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-report
          path: results/
          if-no-files-found: ignore
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: SAST SCANNING (Semgrep)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sast-scan:
    name: "ğŸ” SAST Scanning"
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€ SARIF output (for GitHub Security tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Semgrep (SARIF)
        run: |
          semgrep scan \
            --config=auto \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --config=p/cwe-top-25 \
            --sarif \
            --output=semgrep.sarif \
            --severity=ERROR \
            --severity=WARNING \
            --quiet || true

      # â”€â”€ JSON output (for report + blocking decision) â”€â”€â”€â”€â”€
      - name: Run Semgrep (JSON)
        run: |
          semgrep scan \
            --config=auto \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --config=p/cwe-top-25 \
            --json \
            --output=semgrep.json \
            --severity=ERROR \
            --severity=WARNING \
            --quiet || true

      # â”€â”€ Upload to GitHub Security tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # âœ… Works now â€” repo is public (GHAS free)
      # Results appear under Security â†’ Code scanning alerts
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

      # â”€â”€ Save as downloadable artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload SAST report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-report
          path: |
            semgrep.sarif
            semgrep.json
          if-no-files-found: ignore
          retention-days: 30

      # â”€â”€ Block pipeline on HIGH/ERROR severity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Block on HIGH severity issues
        run: |
          if [ ! -f semgrep.json ]; then
            echo "âš ï¸  semgrep.json not found â€” skipping severity check"
            exit 0
          fi

          COUNT=$(jq '[.results[]? | select(.extra.severity=="ERROR")] | length' semgrep.json 2>/dev/null || echo "0")
          echo "HIGH severity issues: $COUNT"

          if [ "$COUNT" -gt "0" ]; then
            echo ""
            echo "âŒ Found $COUNT HIGH severity issue(s) â€” blocking pipeline"
            echo ""
            jq -r '.results[] | select(.extra.severity=="ERROR") | "  â€¢ [\(.path):\(.start.line)] \(.extra.message)"' semgrep.json || true
            echo ""
            echo "Fix issues or request exception: security@yourcompany.com"
            exit 1
          fi

          echo "âœ… No HIGH severity issues found"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: DEPENDENCY SCANNING (Trivy)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dependency-scan:
    name: "ğŸ›¡ï¸ Dependency Scanning"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€ SARIF output (for GitHub Security tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Trivy (SARIF)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: "."
          format: sarif
          output: trivy.sarif
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      # â”€â”€ Upload to GitHub Security tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # âœ… Works now â€” repo is public (GHAS free)
      # Results appear under Security â†’ Code scanning alerts
      - name: Upload SARIF to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy.sarif
          category: trivy

      # â”€â”€ JSON output (for blocking decision) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run Trivy (JSON + gate)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: "."
          format: json
          output: trivy.json
          severity: "CRITICAL,HIGH"
          exit-code: "1"   # âŒ Blocks if CRITICAL/HIGH CVEs found

      # â”€â”€ Save as downloadable artifact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload dependency report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-report
          path: |
            trivy.sarif
            trivy.json
          if-no-files-found: ignore
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: GENERATE SECURITY DASHBOARD
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-report:
    name: "ğŸ“Š Security Report"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, dependency-scan]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all scan reports
        uses: actions/download-artifact@v4
        with:
          path: reports/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: pip install jinja2

      - name: Generate HTML security dashboard
        run: |
          if [ -f scripts/generate-report.py ]; then
            python scripts/generate-report.py
          else
            cat > security-summary.md << 'SUMMARY'
          ## ğŸ›¡ï¸ SecurOps Security Scan Results

          | Scan | Result |
          |------|--------|
          | ğŸ” Secret Scanning | ${{ needs.secret-scan.result }} |
          | ğŸ” SAST Scanning | ${{ needs.sast-scan.result }} |
          | ğŸ›¡ï¸ Dependency Scanning | ${{ needs.dependency-scan.result }} |

          _See [Actions artifacts](../actions) for full reports._
          SUMMARY
          fi

      - name: Upload security dashboard artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-dashboard
          path: |
            security-dashboard.html
            security-summary.md
          if-no-files-found: ignore
          retention-days: 90

      # â”€â”€ Comment results on PR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Comment results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '';
            try {
              summary = fs.readFileSync('security-summary.md', 'utf8');
            } catch(e) {
              summary = [
                '## ğŸ›¡ï¸ SecurOps Security Scan Results',
                '',
                '| Scan | Result |',
                '|------|--------|',
                `| ğŸ” Secret Scanning | ${{ needs.secret-scan.result }} |`,
                `| ğŸ” SAST Scanning | ${{ needs.sast-scan.result }} |`,
                `| ğŸ›¡ï¸ Dependency Scanning | ${{ needs.dependency-scan.result }} |`,
              ].join('\n');
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            const existing = comments.find(c => c.body.includes('ğŸ›¡ï¸ SecurOps'));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: SECURITY GATE â€” blocks merge if any scan fails
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-gate:
    name: "ğŸš¦ Security Gate"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, dependency-scan]
    if: always()
    steps:
      - name: Evaluate all scan results
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  SecurOps Security Gate"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” Secret Scanning:     ${{ needs.secret-scan.result }}"
          echo "  ğŸ” SAST Scanning:       ${{ needs.sast-scan.result }}"
          echo "  ğŸ›¡ï¸  Dependency Scanning: ${{ needs.dependency-scan.result }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          FAILED=false

          [ "${{ needs.secret-scan.result }}"     != "success" ] && echo "  âŒ Secret scan failed"     && FAILED=true
          [ "${{ needs.sast-scan.result }}"        != "success" ] && echo "  âŒ SAST scan failed"        && FAILED=true
          [ "${{ needs.dependency-scan.result }}"  != "success" ] && echo "  âŒ Dependency scan failed"  && FAILED=true

          echo ""
          if [ "$FAILED" = "true" ]; then
            echo "  âŒ SECURITY GATE FAILED â€” merge is BLOCKED"
            echo "  Fix all issues or contact: security@yourcompany.com"
            exit 1
          fi

          echo "  âœ… SECURITY GATE PASSED â€” safe to merge"
