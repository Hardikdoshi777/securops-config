# ============================================================
# SecurOps GitHub Actions Security Pipeline
# File: .github/workflows/security-scan.yml
# Location: Root of EVERY project repository
# This pipeline CANNOT be bypassed
# ============================================================

name: "ğŸ›¡ï¸ SecurOps Security Pipeline"

on:
  pull_request:
    branches: [main, master, develop, "release/**"]
  push:
    branches: [main, master]
  schedule:
    - cron: "0 2 * * MON"  # Weekly scan Monday 2AM

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: SECRET SCANNING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secret-scan:
    name: "ğŸ” Secret Scanning"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload secret scan report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-report
          path: results/gitleaks.sarif
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: SAST SCANNING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sast-scan:
    name: "ğŸ” SAST Scanning"
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep (SARIF)
        run: |
          semgrep scan \
            --config=auto \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --config=p/cwe-top-25 \
            --sarif \
            --output=semgrep.sarif \
            --severity=ERROR \
            --severity=WARNING \
            --quiet || true

      - name: Run Semgrep (JSON)
        run: |
          semgrep scan \
            --config=auto \
            --config=p/owasp-top-ten \
            --config=p/security-audit \
            --config=p/cwe-top-25 \
            --json \
            --output=semgrep.json \
            --severity=ERROR \
            --severity=WARNING \
            --quiet || true

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep

      - name: Upload SAST report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sast-report
          path: |
            semgrep.sarif
            semgrep.json
          retention-days: 30

      - name: Block on HIGH severity
        run: |
          COUNT=$(jq '[.results[]? | select(.extra.severity=="ERROR")] | length' semgrep.json 2>/dev/null || echo "0")
          echo "HIGH severity issues: $COUNT"
          if [ "$COUNT" -gt "0" ]; then
            echo "âŒ Found $COUNT HIGH severity issues - blocking"
            jq '.results[] | select(.extra.severity=="ERROR") | {file:.path, line:.start.line, issue:.extra.message}' semgrep.json
            exit 1
          fi
          echo "âœ… No HIGH severity issues"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: DEPENDENCY SCANNING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dependency-scan:
    name: "ğŸ›¡ï¸ Dependency Scanning"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: "."
          format: sarif
          output: trivy.sarif
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy.sarif
          category: trivy

      - name: Run Trivy (JSON for report)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: "."
          format: json
          output: trivy.json
          severity: "CRITICAL,HIGH"
          exit-code: "0"

      - name: Upload dependency report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-report
          path: |
            trivy.sarif
            trivy.json
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: GENERATE REPORT
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  generate-report:
    name: "ğŸ“Š Security Report"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, dependency-scan]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports/

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install jinja2

      - name: Generate HTML dashboard
        run: python scripts/generate-report.py

      - name: Upload dashboard
        uses: actions/upload-artifact@v4
        with:
          name: security-dashboard
          path: security-dashboard.html
          retention-days: 90

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let summary = '';
            try { summary = fs.readFileSync('security-summary.md', 'utf8'); } catch(e) { summary = '## Security Scan Complete\nSee artifacts for details.'; }
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number
            });
            const existing = comments.find(c => c.body.includes('ğŸ›¡ï¸ SecurOps'));
            if (existing) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: existing.id, body: summary });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body: summary });
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: SECURITY GATE (FINAL - blocks merge)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-gate:
    name: "ğŸš¦ Security Gate"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, dependency-scan]
    if: always()
    steps:
      - name: Evaluate results
        run: |
          echo "Secret scan:     ${{ needs.secret-scan.result }}"
          echo "SAST scan:       ${{ needs.sast-scan.result }}"
          echo "Dependency scan: ${{ needs.dependency-scan.result }}"

          if [[ "${{ needs.secret-scan.result }}" != "success" || \
                "${{ needs.sast-scan.result }}"   != "success" || \
                "${{ needs.dependency-scan.result }}" != "success" ]]; then
            echo ""
            echo "âŒ SECURITY GATE FAILED â€” merge is blocked"
            echo "Fix all HIGH/CRITICAL issues before merging"
            exit 1
          fi

          echo ""
          echo "âœ… SECURITY GATE PASSED â€” safe to merge"
