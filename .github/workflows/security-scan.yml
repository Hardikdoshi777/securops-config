name: "ğŸ›¡ï¸ SecurOps â€” Complete Security Pipeline"
# âœ… Gitleaks (Secrets) + Semgrep (SAST) + Trivy (SCA) + Nuclei (DAST) + Checkov (IaC)
# âœ… AI Auto-Fix (Claude) + Dashboard + Enrollment Tracking

on:
  pull_request:
    branches: [main, master, develop, "release/**"]
  push:
    branches: [main, master]
  schedule:
    - cron: "0 2 * * MON"

permissions:
  contents: write
  security-events: write
  pull-requests: write
  issues: write

jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1: SECRETS â€” Gitleaks âœ… (was already done)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  secret-scan:
    name: "ğŸ” Secrets (Gitleaks)"
    runs-on: ubuntu-latest
    outputs:
      count: ${{ steps.count.outputs.count }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - id: count
        if: always()
        run: |
          C=$(jq '.runs[0].results|length' results/gitleaks.sarif 2>/dev/null || echo 0)
          echo "count=$C" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-secrets
          path: results/
          if-no-files-found: ignore
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2: SAST â€” Semgrep âœ… (was already done)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sast-scan:
    name: "ğŸ” SAST (Semgrep)"
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    outputs:
      count: ${{ steps.count.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      - name: Semgrep SARIF
        run: |
          semgrep scan --config=auto --config=p/owasp-top-ten \
            --config=p/security-audit --config=p/cwe-top-25 \
            --exclude=.gitleaks.toml \
            --sarif --output=semgrep.sarif \
            --severity=ERROR --severity=WARNING --quiet || true
      - name: Semgrep JSON
        run: |
          semgrep scan --config=auto --config=p/owasp-top-ten \
            --config=p/security-audit --config=p/cwe-top-25 \
            --exclude=.gitleaks.toml \
            --json --output=semgrep.json \
            --severity=ERROR --severity=WARNING --quiet || true
      - id: count
        if: always()
        run: echo "count=$(jq '[.results[]?]|length' semgrep.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
      - uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-sast
          path: semgrep.*
          if-no-files-found: ignore
          retention-days: 30
      - name: Gate on HIGH
        run: |
          C=$(jq '[.results[]?|select(.extra.severity=="ERROR")]|length' semgrep.json 2>/dev/null || echo 0)
          [ "$C" -gt 0 ] && jq -r '.results[]|select(.extra.severity=="ERROR")|"  âŒ [\(.path):\(.start.line)] \(.extra.message)"' semgrep.json && exit 1
          echo "âœ… No HIGH SAST issues"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3: SCA â€” Trivy âœ… (was already done)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  sca-scan:
    name: "ğŸ›¡ï¸ SCA (Trivy)"
    runs-on: ubuntu-latest
    outputs:
      count: ${{ steps.count.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      - uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: "."
          format: sarif
          output: trivy.sarif
          severity: "CRITICAL,HIGH"
          exit-code: "0"
      - uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: trivy.sarif
          category: trivy
      - uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: "."
          format: json
          output: trivy.json
          severity: "CRITICAL,HIGH"
          exit-code: "1"
      - id: count
        if: always()
        run: echo "count=$(jq '[.Results[]?.Vulnerabilities[]?]|length' trivy.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-sca
          path: trivy.*
          if-no-files-found: ignore
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4: DAST â€” Nuclei âœ… NEW
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dast-scan:
    name: "ğŸŒ DAST (Nuclei)"
    runs-on: ubuntu-latest
    outputs:
      count: ${{ steps.count.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Nuclei
        run: |
          wget -qO /tmp/n.zip \
            https://github.com/projectdiscovery/nuclei/releases/download/v3.2.0/nuclei_3.2.0_linux_amd64.zip
          unzip -q /tmp/n.zip -d /tmp
          sudo mv /tmp/nuclei /usr/local/bin/
          nuclei -update-templates -silent 2>/dev/null || true
      - name: Nuclei file scan (configs + exposed secrets)
        run: |
          nuclei -target . \
            -tags exposure,config,file,token \
            -severity medium,high,critical \
            -json-export nuclei.json \
            -no-interactsh -silent || true
      - name: Nuclei URL scan (if TARGET_URL secret is set)
        if: ${{ env.TARGET_URL != '' }}
        env:
          TARGET_URL: ${{ secrets.TARGET_URL }}
        run: |
          nuclei -target "$TARGET_URL" \
            -tags oast,xss,sqli,ssrf,rce,lfi \
            -severity high,critical \
            -json-export nuclei-web.json \
            -no-interactsh -silent || true
          cat nuclei-web.json >> nuclei.json 2>/dev/null || true
      - id: count
        if: always()
        run: echo "count=$(jq -s 'length' nuclei.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
      - name: Gate on CRITICAL/HIGH
        run: |
          CRIT=$(jq -s '[.[]|select(.info.severity=="critical")]|length' nuclei.json 2>/dev/null || echo 0)
          HIGH=$(jq -s '[.[]|select(.info.severity=="high")]|length' nuclei.json 2>/dev/null || echo 0)
          if [ "$CRIT" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            jq -rs '.[]|select(.info.severity=="critical" or .info.severity=="high")|"  âŒ [\(.info.severity|ascii_upcase)] \(.info.name)"' nuclei.json || true
            exit 1
          fi
          echo "âœ… No CRITICAL/HIGH Nuclei findings"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-dast
          path: nuclei.json
          if-no-files-found: ignore
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 5: IaC â€” Checkov âœ… NEW
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  iac-scan:
    name: "ğŸ—ï¸ IaC (Checkov)"
    runs-on: ubuntu-latest
    outputs:
      count: ${{ steps.count.outputs.count }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install checkov --quiet
      - name: Checkov JSON
        run: |
          checkov -d . --output json --output-file checkov.json \
            --soft-fail --quiet --skip-check CKV_GIT_1 2>/dev/null || true
      - name: Checkov SARIF
        run: |
          checkov -d . --output sarif --output-file checkov.sarif \
            --soft-fail --quiet --skip-check CKV_GIT_1 2>/dev/null || true
      - id: count
        if: always()
        run: echo "count=$(jq '[.results?.failed_checks[]?]|length' checkov.json 2>/dev/null || echo 0)" >> $GITHUB_OUTPUT
      - uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: checkov.sarif
          category: checkov
      - name: Gate on CRITICAL IaC
        run: |
          C=$(jq '[.results?.failed_checks[]?|select(.severity=="CRITICAL" and .check_result.result=="FAILED")]|length' checkov.json 2>/dev/null || echo 0)
          if [ "$C" -gt 0 ]; then
            jq -r '.results?.failed_checks[]?|select(.severity=="CRITICAL" and .check_result.result=="FAILED")|"  âŒ \(.check_id) \(.check.name)"' checkov.json || true
            exit 1
          fi
          echo "âœ… No CRITICAL IaC issues"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: report-iac
          path: checkov.*
          if-no-files-found: ignore
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 6: AI AUTO-FIX â€” Claude âœ… NEW
  # Triggers only when scans fail on main branch push
  # Requires: ANTHROPIC_API_KEY in repo secrets
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ai-auto-fix:
    name: "ğŸ¤– AI Auto-Fix (Claude)"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, sca-scan, dast-scan, iac-scan]
    if: |
      always() &&
      github.event_name == 'push' &&
      (needs.secret-scan.result == 'failure' ||
       needs.sast-scan.result   == 'failure' ||
       needs.sca-scan.result    == 'failure' ||
       needs.dast-scan.result   == 'failure' ||
       needs.iac-scan.result    == 'failure')
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download all scan reports
        uses: actions/download-artifact@v4
        with:
          path: reports/
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install anthropic --quiet
      - name: Claude AI Auto-Fix
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
        run: python scripts/ai-auto-fix.py

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 7: DASHBOARD + ENROLLMENT TRACKING âœ… NEW
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  dashboard:
    name: "ğŸ“Š Dashboard & Enrollment"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, sca-scan, dast-scan, iac-scan]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports/
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install jinja2 --quiet
      - name: Generate dashboard + update enrollment
        env:
          ACTOR: ${{ github.actor }}
          REPO: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SECRET_RESULT: ${{ needs.secret-scan.result }}
          SECRET_COUNT: ${{ needs.secret-scan.outputs.count }}
          SAST_RESULT: ${{ needs.sast-scan.result }}
          SAST_COUNT: ${{ needs.sast-scan.outputs.count }}
          SCA_RESULT: ${{ needs.sca-scan.result }}
          SCA_COUNT: ${{ needs.sca-scan.outputs.count }}
          DAST_RESULT: ${{ needs.dast-scan.result }}
          DAST_COUNT: ${{ needs.dast-scan.outputs.count }}
          IAC_RESULT: ${{ needs.iac-scan.result }}
          IAC_COUNT: ${{ needs.iac-scan.outputs.count }}
          EVENT: ${{ github.event_name }}
          REF: ${{ github.ref_name }}
        run: python scripts/generate-report.py
      - uses: actions/upload-artifact@v4
        with:
          name: security-dashboard
          path: |
            security-dashboard.html
            security-summary.md
            enrollment-tracking.json
          if-no-files-found: ignore
          retention-days: 90
      - name: PR comment with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let body = '';
            try { body = fs.readFileSync('security-summary.md', 'utf8'); }
            catch(e) { body = '## ğŸ›¡ï¸ SecurOps Scan Complete\nSee artifacts for full report.'; }
            const {data:comments} = await github.rest.issues.listComments({
              owner:context.repo.owner, repo:context.repo.repo, issue_number:context.issue.number
            });
            const ex = comments.find(c => c.body.includes('ğŸ›¡ï¸ SecurOps'));
            if (ex) {
              await github.rest.issues.updateComment({owner:context.repo.owner,repo:context.repo.repo,comment_id:ex.id,body});
            } else {
              await github.rest.issues.createComment({owner:context.repo.owner,repo:context.repo.repo,issue_number:context.issue.number,body});
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 8: SECURITY GATE â€” final decision, blocks merge
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-gate:
    name: "ğŸš¦ Security Gate"
    runs-on: ubuntu-latest
    needs: [secret-scan, sast-scan, sca-scan, dast-scan, iac-scan]
    if: always()
    steps:
      - name: Evaluate all 5 scan results
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  SecurOps Security Gate â€” All 5 Tools"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  ğŸ” Secrets  (Gitleaks):  ${{ needs.secret-scan.result }}"
          echo "  ğŸ” SAST     (Semgrep):   ${{ needs.sast-scan.result }}"
          echo "  ğŸ›¡ï¸  SCA      (Trivy):     ${{ needs.sca-scan.result }}"
          echo "  ğŸŒ DAST     (Nuclei):    ${{ needs.dast-scan.result }}"
          echo "  ğŸ—ï¸  IaC      (Checkov):   ${{ needs.iac-scan.result }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          FAILED=false
          [ "${{ needs.secret-scan.result }}" != "success" ] && FAILED=true && echo "  âŒ Secrets scan failed"
          [ "${{ needs.sast-scan.result }}"   != "success" ] && FAILED=true && echo "  âŒ SAST scan failed"
          [ "${{ needs.sca-scan.result }}"    != "success" ] && FAILED=true && echo "  âŒ SCA scan failed"
          [ "${{ needs.dast-scan.result }}"   != "success" ] && FAILED=true && echo "  âŒ DAST scan failed"
          [ "${{ needs.iac-scan.result }}"    != "success" ] && FAILED=true && echo "  âŒ IaC scan failed"
          echo ""
          if [ "$FAILED" = "true" ]; then
            echo "  âŒ GATE FAILED â€” merge BLOCKED"
            echo "  Fix all issues or: security@yourcompany.com"
            exit 1
          fi
          echo "  âœ… GATE PASSED â€” safe to merge"
